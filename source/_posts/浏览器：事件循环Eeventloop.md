---
title: 浏览器：事件循环Eeventloop
date: 2019-10-18 21:47:36
tags: 浏览器
category: 技术
---

<meta name="referrer" content="no-referrer"/>

## 一、线程和进程

javascript 是单线程的，也就是说同一个时间只能做一件事。作为浏览器脚本语言，JavaScript 的主要用途是与用户互动，以及操作 DOM。如果浏览器同时有两个线程，一个线程在某个 DOM 节点上添加内容，另一个线程是删除这个节点，那浏览器应该以哪个线程为主呢？

<!--more-->

### 1、进程

CPU 资源分配的最小单位（是能拥有资源和独立运行的最小单位），进程是指在系统中正在运行的一个应用程序，是系统资源分配的基本单位，在内存中有其完备的数据空间和代码空间，拥有完备的虚拟空间地址。一个进程所拥有的数据和变量只属于他自己

### 2、线程

CPU 调度的最小单位（线程是建立在进程的基础上的一次程序运行单位，一个进程中可以有多个线程），线程是进程内相对独立的可执行单元，所以也被称为轻量进程，是操作系统进行任务调度的基本单元。它与父进程的其他线程共享该进程所拥有的全部代码空间和全局变量，但拥有私有的局部变量

### 3、联系

一个进程至少拥有一个线程（主线程），一个线程必须有一个父进程。多个进程可以并发执行；一个线程可以创建或撤销另一个线程；同一个进程中的多个线程之间可以并发执行。

### 4、进程和线程的区别

1. 进程是资源分配和保护的基本单位，线程是处理器调度和分派的基本单位，程序执行的最小单元；
2. 同一个进程中可以包含多个线程，并且线程共享整个进程的资源（寄存器、堆栈、上下文），一个进程至少包含一个线程；
3. 进程结束后，它所有的线程都将销毁，而线程的结束不会影响同个进程中其他线程的结束；
4. 线程是轻量级的进程，它的创建和销毁所需时间和空间都比进程小很多，所有操作系统的执行功能都是创建线程去完成的；
5. 线程有自己的私有属性 TCB，线程 id，寄存器、硬件上下文，而进程也有自己的私有属性进程控制块 PCB，这些私有属性是不被共享的，用来标示一个进程或一个线程的标志；
   6 **系统开销**：在创建或撤销进程时，系统都要为它分配或回收资源，导致系统的开销明显大于创建或撤销线程时的开销；
   7 **资源管理**：进程有独立的地址空间，一个进程崩溃后不会对其他进程产生影响，一个线程死掉会导致整个进程都死掉；
   8 **通信方式**：进程间通信包括管道、系统 IPC（包括消息队列，信号量，共享存储）、SOCKET 等，进程间的通信方式同样适用于线程之间的通信，但是一个进程之间的多个线程使用全局变量通信更高效。

## 二、同步和异步

任务分为同步任务和异步任务

### 1、同步任务

如果在函数返回的时候，调用者就能够得到预期结果（即拿到了预期的返回值或者看到了预期的效果）

### 2、异步任务

如果在函数返回的时候，调用者还不能得到预期结果，而是需要在将来通过一定的手段得到，那么这个函数就是异步的

#### 异步详解

**一个异步过程通常是**

1. 主线程发出一个异步请求，异步任务接到请求并告知主线程已经收到（异步函数返回）；
2. 主线程可以继续执行后面的代码，同时异步操作开始执行；
3. 执行完成后通知主线程；
4. 主线程收到通知后，执行一定的动作（调用回调函数）

**异步类型**

1. 普通事件，如 click、resize 等
2. 资源加载，如 load、error 等
3. 定时器，包括 setInterval、setTimeout 等

**消息队列**

也叫任务队列、事件队列，总之是和异步任务相关的队列。

不管异步任务是什么时候开始执行的，只要异步操作执行完成，他就会被添加到消息队列中排队。

消息就是注册异步任务时添加的回调函数。

## 三、事件循环

![](https://user-gold-cdn.xitu.io/2018/11/23/16740fa4cd9c6937?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

**步骤**

1. 所有同步任务都在主线程上执行，形成一个执行栈
2. 主线程之外，还存在一个“消息队列”，只要异步操作执行完成，就到消息队列中排队
3. 一旦执行栈中的所有同步任务执行完毕，系统就会按次序读取消息队列中的异步任务，于是被读取的异步任务就结束了等待状态，进入到执行栈开始执行
4. 主线程不断重复上面的第三步

**微任务**

process.nextTick，promise，MutationObserver，其中，process.nextTick 为 Node 独有

**宏任务**

script，setTimeout，setInterval，setImmediate，I/O，UI rendering

宏任务中包括了 script，浏览器会先执行一个宏任务，接下来有异步代码的话才会先执行微任务。

宏任务=>所有微任务=>宏任务，如下图：
![](https://user-gold-cdn.xitu.io/2018/6/16/164081cfd8400f92?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

### 面试题实践

```
<script>
  setTimeout(function(){
    console.log(1);
  })
  new Promise((resolve, reject)=>{
    console.log(2);
    resolve(3);
  }).then(res=>{
    console.log(res);
  })
  console.log(4);
</script>
```

**问题：以上代码的打印顺序是什么？**

1. 先执行 script 同步代码，执行 new Promise 中的`console.log(2)`，then 后面的不执行，但是属于微任务，然后执行`console.log(4)`；
2. 执行完 script 宏任务后，执行微任务`console.log(res)=>3`;
3. 执行另一个宏任务，定时器`console.log(1)`。

所以最终输出的是 2,4,3,1。

## 四、同步变异步

每一个消息完整的执行后，其他消息才会被执行，这点提供了一些优秀的特性，包括每当一个函数运行时，他不能被抢占，并且在其他代码运行完之前完全运行。

但是有一个缺点是当消息需要太长时间才能完成，Web 应用无法处理用户的交互，例如点击或滚动。

于是处理这种情况常见的优化就是同步变异步。

[深入理解 JavaScript 中的事件循环 event-loop](https://www.cnblogs.com/xiaohuochai/p/8527618.html#anchor4)
